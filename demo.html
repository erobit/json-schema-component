<style>
  form      { border: 2px dashed green; padding: 2em; padding-top: 0;}
  .errorStr { color: #8B0000; }
  .error    { border-color: #8B0000; }
</style>

<h1>JsonSchemaComponent demo</h1>
<p>
<a href="#">[link to this page]</a>

<div id="formcontainer">
<h2 style="color: green;">This form is generated ..</h2>
<form id=demoform></form>
</div>

<h2 style="color: blue;">.. from this:</h2>
<div style="float: left; width: 32%">
<h3 style="margin-top: 0px;">
  <span style="color: blue;">Data</span>
  <span style="color: green;">(synchronizes with the above form)</span>
</h3>
<textarea id=demotextarea rows=25 style="width: 100%; font-family: monospace;">
{
  "ship_name": "Pequod",
  "abstract": "To seek out a specific whale",
  "revenge": true,
  "captain": "Ahab",
  "harpooneers": ["Queequeg", "Tashtego"],
  "arrival": "1820-11-20"
}
</textarea>
</div>

<div style="float: left; width: 32%; padding-left: 2%;">
<h3 style="color: blue; margin-top: 0px;">Schema</h3>
<textarea id=schema rows=25 style="width: 100%; font-family: monospace;">
{
  "name" : "Sea voyage",
  "properties" : {
    "ship_name" : {
      "type" : "string",
      "description" : "Ship name",
      "required" : true,
      "pattern": ".+"
    },
    "abstract" : {
      "type" : "string",
      "description" : "Travel purpose (must contain the word 'whale')",
      "required": false,
      "pattern": ".*whale.*"
    },
    "revenge" : {
      "description" : "Revenge ?",
      "type" : "boolean"
    },
    "captain" : {
      "description" : "Captain",
      "type" : "string",
      "enum" : ["Ahab", "Picard", "Han Solo", "Anakin Skywalker"]
    },
    "departure": {
      "type": "time"
    },
    "arrival": {
      "description": "Arrival",
      "type": "date"
    },
    "harpooneers" : {
      "description" : "Which Harpooneers do you like the most (choose 2 to 3)?",
      "type" : "array",
      "minItems": 2,
      "maxItems": 3,
      "items": {
        "type" : "string",
        "enum" : ["Queequeg", "Tashtego", "Daggoo", "Fedallah"]
      }
    }
  }
}
</textarea>
</div>

<div style="float: left; width: 32%; padding-left: 2%;">
<h3 style="color: blue; margin-top: 0px;">Template</h3>
<textarea id=template rows=25 style="width: 100%; font-family: monospace;"></textarea>

</div>

<hr style="clear: both;">
<a href="https://github.com/p7s1digital/json-schema-component">JsonSchemaComponent on GitHub</a>

<script src=vendor/json2.js></script>
<script src=vendor/jquery-1.7.1.js></script>
<script src=vendor/jquery.tmpl.js></script>
<script src=vendor/uri.js></script>
<script src=vendor/jsv.js></script>
<script src=vendor/json-schema-draft-03.js></script>
<script>
/* the three modules above create a non-standard 'window.require' object, that
makes the following two libraries trip when loading additional modules */
delete window.require;
</script>

<script src="http://afarkas.github.com/webshim/demos/js-webshim/minified/extras/modernizr-custom.js"></script>
<script src="http://afarkas.github.com/webshim/demos/js-webshim/minified/polyfiller.js"></script>

<script src=src/JsonSchemaComponent.js></script>

<script>
$.webshims.polyfill("forms-ext");
$.webshims.ready('forms-ext', function() {

function load_from_hash() {
  if (!/^#preset=.*/.test(window.location.hash)) {
    return false;
  }

  var preset = JSON.parse(decodeURI(
    /^#preset=(.*)/.exec(window.location.hash)[1]
  ));

  $("#schema").val(preset.schema);
  $("#demotextarea").val(preset.data);
  $("#template").val(preset.template);

  return true;
}

function save_to_hash() {
  window.location.hash = encodeURI(
    "preset=" +
    JSON.stringify({
      schema: $('#schema').val(),
      data: $('#demotextarea').val(),
      template: $('#template').val()
    })
  );

  document.links[0].href = window.location.hash;
}

function invalidate_form() {
  save_to_hash();
  window.location.reload();
  $("#formcontainer").replaceWith("<button onclick='javascript:window.location.reload();'>Re-generate form</button>");
}

$('#template').val(JsonSchemaComponent.prototype.TEMPLATE);

$('#demotextarea').change(invalidate_form);
$('#schema').change(invalidate_form);
$('#template').change(invalidate_form);

load_from_hash();

var demoform = $('#demoform');
var mycomponent = new JsonSchemaComponent({
  schema: JSON.parse($('#schema').val()),
  textarea: $('#demotextarea'),
  template: $('#template').val(),
  form: demoform
});
demoform.on("validates", function() {
  demoform.find("input[type=submit]").removeAttr("disabled");
});
demoform.on("errors", function(errors) {
  // do something with the errors
  demoform.find("input[type=submit]").attr("disabled", "disabled");
});
demoform.append("<input type=submit value='Set sails!' /> (<i>form needs to validate for this to be enabled</i>)");

});

</script>
